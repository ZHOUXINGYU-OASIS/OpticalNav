function H = cal_H_angle_dis(xs, xa)
%% Calculate the Jacobi matrix of the angle and distance measurements
rsx = xs(1);
rsy = xs(2);
rsz = xs(3);
rax = xa(1);
ray = xa(2);
raz = xa(3);
H = zeros(3, 6);
%% Angle measurement
%% az
daz_drsx = -(((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2*(((abs(rax - rsx)*sign(rax - rsx)*(imag(rax) - imag(rsx)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2) + (abs(rax - rsx)*sign(rax - rsx)*(real(ray) - real(rsy)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2))/((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2)) - (((imag(rax) - imag(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (real(ray) - real(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))*(1/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (abs(rax - rsx)*sign(rax - rsx)*(imag(ray) - imag(rsy)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2) - (abs(rax - rsx)*sign(rax - rsx)*(real(rax) - real(rsx)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2)))/((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2))/(((imag(rax) - imag(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (real(ray) - real(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2 + ((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2);
daz_drsy = -(((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2*(((abs(ray - rsy)*sign(ray - rsy)*(imag(rax) - imag(rsx)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2) - 1/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (abs(ray - rsy)*sign(ray - rsy)*(real(ray) - real(rsy)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2))/((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2)) - (((imag(rax) - imag(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (real(ray) - real(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))*((abs(ray - rsy)*sign(ray - rsy)*(imag(ray) - imag(rsy)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2) - (abs(ray - rsy)*sign(ray - rsy)*(real(rax) - real(rsx)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2)))/((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2))/(((imag(rax) - imag(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (real(ray) - real(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2 + ((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2);
daz_drsz = -(((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2*(((abs(raz - rsz)*sign(raz - rsz)*(imag(rax) - imag(rsx)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2) + (abs(raz - rsz)*sign(raz - rsz)*(real(ray) - real(rsy)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2))/((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2)) - (((imag(rax) - imag(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (real(ray) - real(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))*((abs(raz - rsz)*sign(raz - rsz)*(imag(ray) - imag(rsy)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2) - (abs(raz - rsz)*sign(raz - rsz)*(real(rax) - real(rsx)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2)))/((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2))/(((imag(rax) - imag(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (real(ray) - real(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2 + ((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2);
daz_drax = (((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2*(((abs(rax - rsx)*sign(rax - rsx)*(imag(rax) - imag(rsx)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2) + (abs(rax - rsx)*sign(rax - rsx)*(real(ray) - real(rsy)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2))/((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2)) - (((imag(rax) - imag(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (real(ray) - real(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))*(1/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (abs(rax - rsx)*sign(rax - rsx)*(imag(ray) - imag(rsy)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2) - (abs(rax - rsx)*sign(rax - rsx)*(real(rax) - real(rsx)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2)))/((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2))/(((imag(rax) - imag(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (real(ray) - real(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2 + ((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2);
daz_dray = (((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2*(((abs(ray - rsy)*sign(ray - rsy)*(imag(rax) - imag(rsx)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2) - 1/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (abs(ray - rsy)*sign(ray - rsy)*(real(ray) - real(rsy)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2))/((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2)) - (((imag(rax) - imag(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (real(ray) - real(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))*((abs(ray - rsy)*sign(ray - rsy)*(imag(ray) - imag(rsy)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2) - (abs(ray - rsy)*sign(ray - rsy)*(real(rax) - real(rsx)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2)))/((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2))/(((imag(rax) - imag(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (real(ray) - real(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2 + ((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2);
daz_draz = (((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2*(((abs(raz - rsz)*sign(raz - rsz)*(imag(rax) - imag(rsx)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2) + (abs(raz - rsz)*sign(raz - rsz)*(real(ray) - real(rsy)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2))/((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2)) - (((imag(rax) - imag(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (real(ray) - real(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))*((abs(raz - rsz)*sign(raz - rsz)*(imag(ray) - imag(rsy)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2) - (abs(raz - rsz)*sign(raz - rsz)*(real(rax) - real(rsx)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2)))/((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2))/(((imag(rax) - imag(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) + (real(ray) - real(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2 + ((imag(ray) - imag(rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (real(rax) - real(rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2);
%% elev
delev_drsx = (((imag(((2*abs(rax - rsx)*sign(rax - rsx)*(rax - rsx)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2 - (2*rax - 2*rsx)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (2*abs(rax - rsx)*sign(rax - rsx)*(ray - rsy)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2)/((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2))/2 - (abs(rax - rsx)*sign(rax - rsx)*(real(raz) - real(rsz)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2))/(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2)) - ((imag(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) - (real(raz) - real(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))*(real(((2*abs(rax - rsx)*sign(rax - rsx)*(rax - rsx)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2 - (2*rax - 2*rsx)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (2*abs(rax - rsx)*sign(rax - rsx)*(ray - rsy)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2)/((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2))/2 + (abs(rax - rsx)*sign(rax - rsx)*(imag(raz) - imag(rsz)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2)))/(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2)*(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2)/((real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2 + (imag(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) - (real(raz) - real(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2);
delev_drsy = (((imag(((2*abs(ray - rsy)*sign(ray - rsy)*(rax - rsx)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2 - (2*ray - 2*rsy)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (2*abs(ray - rsy)*sign(ray - rsy)*(ray - rsy)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2)/((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2))/2 - (abs(ray - rsy)*sign(ray - rsy)*(real(raz) - real(rsz)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2))/(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2)) - ((imag(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) - (real(raz) - real(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))*(real(((2*abs(ray - rsy)*sign(ray - rsy)*(rax - rsx)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2 - (2*ray - 2*rsy)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (2*abs(ray - rsy)*sign(ray - rsy)*(ray - rsy)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2)/((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2))/2 + (abs(ray - rsy)*sign(ray - rsy)*(imag(raz) - imag(rsz)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2)))/(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2)*(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2)/((real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2 + (imag(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) - (real(raz) - real(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2);
delev_drsz = ((real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2*((imag(((2*abs(raz - rsz)*sign(raz - rsz)*(rax - rsx)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2 + (2*abs(raz - rsz)*sign(raz - rsz)*(ray - rsy)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2)/((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2))/2 + 1/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (abs(raz - rsz)*sign(raz - rsz)*(real(raz) - real(rsz)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2))/(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2)) - ((imag(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) - (real(raz) - real(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))*(real(((2*abs(raz - rsz)*sign(raz - rsz)*(rax - rsx)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2 + (2*abs(raz - rsz)*sign(raz - rsz)*(ray - rsy)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2)/((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2))/2 + (abs(raz - rsz)*sign(raz - rsz)*(imag(raz) - imag(rsz)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2)))/(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2))/((real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2 + (imag(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) - (real(raz) - real(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2);
delev_drax = -(((imag(((2*abs(rax - rsx)*sign(rax - rsx)*(rax - rsx)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2 - (2*rax - 2*rsx)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (2*abs(rax - rsx)*sign(rax - rsx)*(ray - rsy)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2)/((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2))/2 - (abs(rax - rsx)*sign(rax - rsx)*(real(raz) - real(rsz)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2))/(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2)) - ((imag(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) - (real(raz) - real(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))*(real(((2*abs(rax - rsx)*sign(rax - rsx)*(rax - rsx)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2 - (2*rax - 2*rsx)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (2*abs(rax - rsx)*sign(rax - rsx)*(ray - rsy)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2)/((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2))/2 + (abs(rax - rsx)*sign(rax - rsx)*(imag(raz) - imag(rsz)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2)))/(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2)*(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2)/((real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2 + (imag(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) - (real(raz) - real(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2);
delev_dray = -(((imag(((2*abs(ray - rsy)*sign(ray - rsy)*(rax - rsx)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2 - (2*ray - 2*rsy)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (2*abs(ray - rsy)*sign(ray - rsy)*(ray - rsy)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2)/((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2))/2 - (abs(ray - rsy)*sign(ray - rsy)*(real(raz) - real(rsz)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2))/(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2)) - ((imag(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) - (real(raz) - real(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))*(real(((2*abs(ray - rsy)*sign(ray - rsy)*(rax - rsx)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2 - (2*ray - 2*rsy)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (2*abs(ray - rsy)*sign(ray - rsy)*(ray - rsy)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2)/((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2))/2 + (abs(ray - rsy)*sign(ray - rsy)*(imag(raz) - imag(rsz)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2)))/(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2)*(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2)/((real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2 + (imag(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) - (real(raz) - real(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2);
delev_draz = -((real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2*((imag(((2*abs(raz - rsz)*sign(raz - rsz)*(rax - rsx)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2 + (2*abs(raz - rsz)*sign(raz - rsz)*(ray - rsy)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2)/((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2))/2 + 1/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (abs(raz - rsz)*sign(raz - rsz)*(real(raz) - real(rsz)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2))/(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2)) - ((imag(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) - (real(raz) - real(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))*(real(((2*abs(raz - rsz)*sign(raz - rsz)*(rax - rsx)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2 + (2*abs(raz - rsz)*sign(raz - rsz)*(ray - rsy)^2)/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^2)/((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2))/2 + (abs(raz - rsz)*sign(raz - rsz)*(imag(raz) - imag(rsz)))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2)))/(real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2))/((real(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) + (imag(raz) - imag(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2 + (imag(((rax - rsx)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2) + (ray - rsy)^2/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2))^(1/2)) - (real(raz) - real(rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2))^2);
% % lx
% dlx_drsx = 1/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (abs(rax - rsx)*sign(rax - rsx)*(rax - rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2);
% dlx_drsy = -(abs(ray - rsy)*sign(ray - rsy)*(rax - rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2);
% dlx_drsz = -(abs(raz - rsz)*sign(raz - rsz)*(rax - rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2);
% % ly
% dly_drsx = -(abs(rax - rsx)*sign(rax - rsx)*(ray - rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2);
% dly_drsy = 1/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (abs(ray - rsy)*sign(ray - rsy)*(ray - rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2);
% dly_drsz = -(abs(raz - rsz)*sign(raz - rsz)*(ray - rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2);
% % lz
% dlz_drsx = -(abs(rax - rsx)*sign(rax - rsx)*(raz - rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2);
% dlz_drsy = -(abs(ray - rsy)*sign(ray - rsy)*(raz - rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2);
% dlz_drsz = 1/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2) - (abs(raz - rsz)*sign(raz - rsz)*(raz - rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(3/2);
%% Distance measurement
% dis
dr_drsx = -(abs(rax - rsx)*sign(rax - rsx))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2);
dr_drsy = -(abs(ray - rsy)*sign(ray - rsy))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2); 
dr_drsz = -(abs(raz - rsz)*sign(raz - rsz))/(abs(rax - rsx)^2 + abs(ray - rsy)^2 + abs(raz - rsz)^2)^(1/2);
%% H matrix
% H(1:3, 1:3) = [dlx_drsx, dlx_drsy, dlx_drsz;
%                dly_drsx, dly_drsy, dly_drsz;
%                dlz_drsx, dlz_drsy, dlz_drsz];
H(1:2, 1:3) = [daz_drsx, daz_drsy, daz_drsz;
               delev_drsx, delev_drsy, delev_drsz];
H(3, 1:3) = [dr_drsx, dr_drsy, dr_drsz];